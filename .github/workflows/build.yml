name: Build Extension

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          path: AlQanime

      - name: Setup JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: 'zulu'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Clone CloudStream
        run: |
          git clone https://github.com/recloudstream/cloudstream.git
          cd cloudstream
          git checkout master || git checkout main

      - name: Copy extension to CloudStream
        run: |
          mkdir -p cloudstream/AlQanimeProvider
          cp -r AlQanime/* cloudstream/AlQanimeProvider/
          cd cloudstream
          echo "include(':AlQanimeProvider')" >> settings.gradle.kts

      - name: Build Extension
        run: |
          cd cloudstream
          chmod +x gradlew
          ./gradlew AlQanimeProvider:make --stacktrace

      - name: Upload Extension
        uses: actions/upload-artifact@v3
        with:
          name: AlQanime-extension
          path: cloudstream/builds/AlQanimeProvider.cs3

      - name: Move to builds folder
        run: |
          mkdir -p AlQanime/builds
          cp cloudstream/builds/AlQanimeProvider.cs3 AlQanime/builds/AlQanime.cs3 || echo "Build file not found"

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Auto-build extension [skip ci]"
          file_pattern: builds/*.cs3
          repository: AlQanime
